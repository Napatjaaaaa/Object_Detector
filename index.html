<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>AI Object Detector with Voice (Full Features)</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 20px; }
    video { border: 2px solid black; width: 80%; max-width: 600px; }
    .controls { margin-top: 10px; }
    button { margin: 5px; padding: 8px 15px; }
    .label { font-size: 1.2em; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>AI Object Detector with Voice</h1>
  <video id="video" autoplay playsinline></video>
  <div class="label" id="label" style="display:none;"></div>
  <p id="message"></p>

  <div class="controls">
    <select id="cameraSelect"></select>
    <button id="btnStart">เริ่มกล้อง</button>
    <button id="btnStop">หยุดกล้อง</button>
    <button id="btnMute">ปิดเสียงพูด</button>
    <label>เสียง:
      <input type="range" id="volumeSlider" min="0" max="100" value="100">
      <span id="volumeValue">100</span>%
    </label>
    <button id="btnReset">รีเซ็ต</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <script>
    const video = document.getElementById('video');
    const label = document.getElementById('label');
    const message = document.getElementById('message');
    const cameraSelect = document.getElementById('cameraSelect');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnMute = document.getElementById('btnMute');
    const muteText = btnMute;
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeValue = document.getElementById('volumeValue');
    const btnReset = document.getElementById('btnReset');

    let model;
    let stream;
    let isMuted = false;
    let speechVolume = 1.0;
    let currentDeviceId = null;

    async function listCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      cameraSelect.innerHTML = '';
      devices.forEach(device => {
        if (device.kind === 'videoinput') {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.text = device.label || `กล้อง ${cameraSelect.length + 1}`;
          cameraSelect.appendChild(option);
        }
      });
    }

    async function startCameraAndDetect(deviceId) {
      stopCamera();
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: deviceId ? { exact: deviceId } : undefined }
        });
        video.srcObject = stream;
        currentDeviceId = deviceId;
        detectFrame();
      } catch (err) {
        message.textContent = 'ไม่สามารถเปิดกล้องได้: ' + err.message;
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    async function detectFrame() {
      if (!model) {
        model = await cocoSsd.load();
      }
      const predictions = await model.detect(video);
      if (predictions.length > 0) {
        const topPrediction = predictions[0];
        label.textContent = `${topPrediction.class} (${Math.round(topPrediction.score * 100)}%)`;
        label.style.display = 'block';
        if (!isMuted) speak(label.textContent);
      } else {
        label.style.display = 'none';
      }
      requestAnimationFrame(detectFrame);
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.volume = speechVolume;
      speechSynthesis.speak(utterance);
    }

    btnStart.addEventListener('click', async () => {
      await listCameras();
      await startCameraAndDetect(cameraSelect.value);
    });

    btnStop.addEventListener('click', stopCamera);

    btnMute.addEventListener('click', () => {
      isMuted = !isMuted;
      muteText.textContent = isMuted ? 'เปิดเสียงพูด' : 'ปิดเสียงพูด';
    });

    volumeSlider.addEventListener('input', () => {
      const vol = volumeSlider.value;
      volumeValue.textContent = vol;
      speechVolume = vol / 100;
    });

    btnReset.addEventListener('click', () => {
      // รีเซ็ตค่าต่างๆ โดยไม่ตัดสัญญาณกล้อง
      label.style.display = 'none';
      message.textContent = '';
      isMuted = false;
      muteText.textContent = 'ปิดเสียงพูด';
      volumeSlider.value = 100;
      volumeValue.textContent = 100;
      speechVolume = 1.0;
    });

    window.onload = listCameras;
  </script>
</body>
</html>
