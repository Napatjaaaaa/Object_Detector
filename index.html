<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>AI Object Detector with Voice (Full Features)</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    --bg-grad-start: #FFF7F0;
    --bg-grad-end: #F0FEFF;
    --accent: #ff7aa2;
    --accent-2: #6ec6ff;
    --card-bg: rgba(255,255,255,0.92);
    --muted: #666;
    --danger: #e74c3c;
  }
  body{
    font-family: 'Kanit', sans-serif;
    background: linear-gradient(160deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
    margin:0;
    padding:20px;
  }
  .container{max-width:1000px;margin:auto;}
  h1{margin:0;font-size:24px;}
  p.subtitle{margin:0;color:var(--muted);}
  .card{
    background: var(--card-bg);
    border-radius:14px;
    padding:14px;
    box-shadow: 0 8px 30px rgba(16,24,40,0.06);
    backdrop-filter: blur(6px);
    margin-top:10px;
  }
  video#webcam{
    width:100%;
    max-width:880px;
    border-radius:10px;
    background:#000;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  }
  #label{
    margin-top:8px;
    font-weight:700;
    text-align:center;
  }
  #controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px;}
  .btn{
    display:inline-flex;gap:6px;align-items:center;padding:10px 14px;
    border-radius:10px;background:white;border: 1px solid rgba(0,0,0,0.06);
    box-shadow: 0 6px 12px rgba(0,0,0,0.06);cursor:pointer;font-weight:600;
  }
  select, input[type="range"]{padding:6px;border-radius:6px;}
  #message{color:var(--danger);text-align:center;margin-top:10px;}
</style>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
<div class="container">
  <h1>กล้องตรวจจับวัตถุพร้อมเสียงพูด</h1>
  <p class="subtitle">ออกแบบสำหรับโครงงานการเรียนรู้ — รองรับมือถือและเดสก์ท็อป</p>

  <div class="card" id="startScreen">
    <button id="startBtn" class="btn"><span class="material-icons">videocam</span>กดเริ่มใช้งาน</button>
    <p>โปรดกดปุ่มเพื่อเปิดกล้องและอนุญาตเสียงพูด</p>
  </div>

  <p id="message"></p>

  <div class="card">
    <video id="webcam" autoplay muted playsinline style="display:none;"></video>
    <p id="label"></p>
  </div>

  <div id="controls" style="display:none;" class="card">
    <button id="toggleCamBtn" class="btn"><span class="material-icons">videocam_off</span>ปิดกล้อง</button>
    <button id="toggleDetectBtn" class="btn"><span class="material-icons">visibility_off</span>หยุดตรวจจับ</button>
    <button id="muteBtn" class="btn"><span class="material-icons">volume_up</span>ปิดเสียงพูด</button>
    <br/>
    <label>เลือกกล้อง: <select id="cameraSelect"></select></label>
    <br/>
    <label>เสียงพูด: <span id="volumeValue">100</span>%</label>
    <input type="range" id="volumeSlider" min="0" max="100" value="100" />
  </div>
</div>

<script>
const startBtn = document.getElementById('startBtn');
const startScreen = document.getElementById('startScreen');
const video = document.getElementById('webcam');
const controls = document.getElementById('controls');
const toggleCamBtn = document.getElementById('toggleCamBtn');
const toggleDetectBtn = document.getElementById('toggleDetectBtn');
const muteBtn = document.getElementById('muteBtn');
const volumeSlider = document.getElementById('volumeSlider');
const volumeValue = document.getElementById('volumeValue');
const label = document.getElementById('label');
const cameraSelect = document.getElementById('cameraSelect');
const message = document.getElementById('message');

let model, stream = null;
let isCameraOn = false, detecting = true, isMuted = false;
let lastSpokenTimes = {}, speechVolume = 1.0, currentDeviceId = null;

const labelDict = {
  "chair": "เก้าอี้","couch": "โซฟา","bed": "เตียง","dining table": "โต๊ะ",
  "tv": "ทีวี","cell phone": "โทรศัพท์","book": "หนังสือ","bottle": "ขวดน้ำ",
  "cup": "ถ้วย","bowl": "ชาม","remote": "รีโมท","mouse": "เมาส์",
  "keyboard": "คีย์บอร์ด","laptop": "โน้ตบุ๊ก","microwave": "ไมโครเวฟ",
  "sports ball": "ลูกบอล","scissors": "กรรไกร","backpack": "กระเป๋า",
  "teddy bear": "ตุ๊กตา","pen": "ปากกา","pencil": "ดินสอ","eraser": "ยางลบ",
  "headphones": "หูฟัง","box": "กล่อง"
};

async function listCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(d => d.kind === 'videoinput');
  cameraSelect.innerHTML = '';
  videoDevices.forEach((device, idx) => {
    const opt = document.createElement('option');
    opt.value = device.deviceId;
    opt.text = device.label || `กล้อง ${idx+1}`;
    cameraSelect.appendChild(opt);
  });
  if(videoDevices.length > 0){
    currentDeviceId = videoDevices[0].deviceId;
    cameraSelect.value = currentDeviceId;
  }
}

async function setupCamera(deviceId = null) {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = await navigator.mediaDevices.getUserMedia({
    video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "environment" },
    audio: false
  });
  video.srcObject = stream;
  return new Promise(res => { video.onloadedmetadata = () => res(); });
}

function speak(text){
  if(isMuted) return;
  const now = Date.now();
  if (!lastSpokenTimes[text] || now - lastSpokenTimes[text] > 3000) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "th-TH";
    utter.volume = speechVolume;
    speechSynthesis.speak(utter);
    lastSpokenTimes[text] = now;
  }
}

async function detectFrame(){
  if(!detecting) return;
  if(video.videoWidth === 0) { requestAnimationFrame(detectFrame); return; }
  const predictions = await model.detect(video);
  if(predictions.length > 0){
    let found = false;
    for(const pred of predictions){
      if(labelDict[pred.class]){
        const name = labelDict[pred.class];
        label.textContent = `พบวัตถุ: ${name}`;
        speak(name);
        found = true;
        break;
      }
    }
    if(!found) label.textContent = "พบวัตถุที่ไม่มีคำแปลภาษาไทย";
  } else label.textContent = "กำลังตรวจจับวัตถุ...";
  requestAnimationFrame(detectFrame);
}

async function startCameraAndDetect(deviceId = null){
  await setupCamera(deviceId);
  video.style.display = 'block';
  if(!model){ label.textContent = "กำลังโหลดโมเดล..."; model = await cocoSsd.load(); }
  label.textContent = "พร้อมตรวจจับวัตถุ!";
  detecting = true;
  detectFrame();
  isCameraOn = true;
  toggleCamBtn.innerHTML = `<span class="material-icons">videocam_off</span>ปิดกล้อง`;
}

function stopCameraAndDetect(){
  detecting = false;
  if(stream) stream.getTracks().forEach(t => t.stop());
  video.srcObject = null;
  video.style.display = 'none';
  isCameraOn = false;
  toggleCamBtn.innerHTML = `<span class="material-icons">videocam</span>เปิดกล้อง`;
}

toggleCamBtn.onclick = () => isCameraOn ? stopCameraAndDetect() : startCameraAndDetect(currentDeviceId);
toggleDetectBtn.onclick = () => {
  detecting = !detecting;
  toggleDetectBtn.innerHTML = detecting ? `<span class="material-icons">visibility_off</span>หยุดตรวจจับ` : `<span class="material-icons">visibility</span>เริ่มตรวจจับ`;
  if(detecting) detectFrame(); else label.textContent = 'หยุดตรวจจับแล้ว';
};
muteBtn.onclick = () => {
  isMuted = !isMuted;
  muteBtn.innerHTML = isMuted ? `<span class="material-icons">volume_off</span>เปิดเสียงพูด` : `<span class="material-icons">volume_up</span>ปิดเสียงพูด`;
};
volumeSlider.oninput = () => { volumeValue.textContent = volumeSlider.value; speechVolume = volumeSlider.value / 100; };
cameraSelect.onchange = () => { currentDeviceId = cameraSelect.value; if(isCameraOn) startCameraAndDetect(currentDeviceId); };

startBtn.onclick = async () => {
  startScreen.style.display = 'none';
  controls.style.display = 'block';
  await listCameras();
  await startCameraAndDetect(currentDeviceId);
};
</script>
</body>
</html>
